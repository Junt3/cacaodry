{% extends "base.html" %}

{% block title %}Registro de Errores - Sistema de Secado de Cacao{% endblock %}

{% block content %}
<div class="errores-container">
    <div class="errores-header">
        <h2>Registro de Errores del Sistema</h2>
        <div class="errores-actions">
            <a href="{{ url_for('index') }}" class="btn btn-primary">Volver al Inicio</a>
            <a href="{{ url_for('historial') }}" class="btn btn-secondary">Ver Historial</a>
            <button type="button" class="btn btn-danger" onclick="confirmarLimpiarErrores()">Limpiar Todos</button>
        </div>
    </div>

    {% if errores.items %}
    <div class="table-container">
        <table class="errores-table">
            <thead>
                <tr>
                    <th>Fecha y Hora</th>
                    <th>Tipo de Error</th>
                    <th>Mensaje</th>
                    <th>Datos de Entrada</th>
                    <th>IP</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for error in errores.items %}
                <tr>
                    <td>{{ error.fecha_hora.strftime('%d/%m/%Y %H:%M:%S') }}</td>
                    <td>
                        <span class="badge badge-{{ 'danger' if error.tipo_error == 'CALCULO' else 'warning' }}">
                            {{ error.tipo_error }}
                        </span>
                    </td>
                    <td class="mensaje-error">{{ error.mensaje_error }}</td>
                    <td>
                        {% if error.datos_entrada %}
                            <button type="button" class="btn btn-sm btn-info" onclick="mostrarDatosEntrada('{{ error.id }}')">Ver</button>
                        {% else %}
                            <span class="text-muted">N/A</span>
                        {% endif %}
                    </td>
                    <td>{{ error.ip_address or 'N/A' }}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="confirmarEliminarError({{ error.id }})">Eliminar</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    {% if errores.pages > 1 %}
    <div class="pagination">
        {% if errores.has_prev %}
            <a href="{{ url_for('ver_errores', pagina=errores.prev_num) }}" class="btn btn-secondary">« Anterior</a>
        {% endif %}
        
        <span class="pagination-info">
            Página {{ errores.page }} de {{ errores.pages }}
        </span>
        
        {% if errores.has_next %}
            <a href="{{ url_for('ver_errores', pagina=errores.next_num) }}" class="btn btn-secondary">Siguiente »</a>
        {% endif %}
    </div>
    {% endif %}

{% else %}
    <div class="empty-state">
        <h3>No hay errores registrados</h3>
        <p>El sistema no ha registrado ningún error.</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">Volver al Inicio</a>
    </div>
{% endif %}
</div>

<!-- Modal para mostrar datos de entrada -->
<div id="datosModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Datos de Entrada que Causaron el Error</h3>
            <span class="close" onclick="cerrarDatosModal()">&times;</span>
        </div>
        <div class="modal-body" id="datosContenido">
            <!-- Los datos se cargarán aquí mediante JavaScript -->
        </div>
    </div>
</div>

<script>
function mostrarDatosEntrada(errorId) {
    // Obtener los datos del error mediante una llamada AJAX
    fetch(`/api/error/${errorId}`)
        .then(response => response.json())
        .then(data => {
            if (data.datos_entrada) {
                try {
                    const datos = JSON.parse(data.datos_entrada);
                    let html = '<div class="datos-grid">';
                    
                    for (const [key, value] of Object.entries(datos)) {
                        html += `
                            <div class="dato-item">
                                <strong>${key}:</strong>
                                <span class="dato-valor">${value}</span>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    document.getElementById('datosContenido').innerHTML = html;
                    document.getElementById('datosModal').style.display = 'block';
                } catch (e) {
                    document.getElementById('datosContenido').innerHTML = '<p>Error al procesar los datos</p>';
                    document.getElementById('datosModal').style.display = 'block';
                }
            } else {
                document.getElementById('datosContenido').innerHTML = '<p>No hay datos disponibles</p>';
                document.getElementById('datosModal').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('datosContenido').innerHTML = '<p>Error al cargar los datos</p>';
            document.getElementById('datosModal').style.display = 'block';
        });
}

function cerrarDatosModal() {
    document.getElementById('datosModal').style.display = 'none';
}

// Cerrar modal al hacer clic fuera de él
window.onclick = function(event) {
    const modal = document.getElementById('datosModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// Función para confirmar limpieza de todos los errores
function confirmarLimpiarErrores() {
    mostrarConfirmacion('Confirmar Eliminación', '¿Está seguro de eliminar todos los registros de errores?', function() {
        // Crear un formulario dinámico y enviarlo
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/limpiar/errores';
        document.body.appendChild(form);
        form.submit();
    });
}

// Función para confirmar eliminación de un error individual
function confirmarEliminarError(id) {
    mostrarConfirmacion('Confirmar Eliminación', '¿Está seguro de eliminar este registro de error?', function() {
        // Crear un formulario dinámico y enviarlo
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/eliminar/error/${id}`;
        document.body.appendChild(form);
        form.submit();
    });
}
</script>

<style>
.errores-container {
    background: white;
    border-radius: 10px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.errores-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.errores-actions {
    display: flex;
    gap: 0.5rem;
}

.table-container {
    overflow-x: auto;
}

.errores-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 2rem;
}

.errores-table th,
.errores-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.errores-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #8B4513;
}

.errores-table tr:hover {
    background: #f8f9fa;
}

.mensaje-error {
    max-width: 300px;
    word-wrap: break-word;
    font-size: 0.9rem;
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
}

.badge-danger {
    background: #f8d7da;
    color: #721c24;
}

.badge-warning {
    background: #fff3cd;
    color: #856404;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
}

.pagination-info {
    font-weight: 600;
    color: #666;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #666;
}

.empty-state h3 {
    margin-bottom: 1rem;
    color: #8B4513;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    background: #8B4513;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    opacity: 0.7;
}

.modal-body {
    padding: 1.5rem;
}

.datos-grid {
    display: grid;
    gap: 1rem;
}

.dato-item {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 6px;
    border-left: 4px solid #8B4513;
}

.dato-valor {
    color: #495057;
    font-family: monospace;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

@media (max-width: 768px) {
    .errores-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .errores-actions {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .mensaje-error {
        max-width: 200px;
    }
}
</style>
{% endblock %}